<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Hazards Portal - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/login.css">
</head>
<body>
    <!-- Subtle Water Wave Background -->
    <div class="waves">
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>Ocean Hazards Portal</h1>
            <p>Access real-time ocean hazard information, forecasts, and verification systems. Select your role to continue.</p>
        </div>
        
        <div class="login-options">
            <div class="login-card user">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>Login as User</h2>
                </div>
                <div class="card-body">
                    <p>Access ocean hazard forecasts, alerts, and safety information for your region.</p>
                    <div class="btn-container">
                        <a href="#" class="btn" onclick="openLoginModal('user')"><span>User Login</span> <i class="fas fa-arrow-right"></i></a>
                        <a href="#" class="btn btn-signup" onclick="openSignupModal()"><span>Sign Up</span> <i class="fas fa-user-plus"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="login-card official">
                <div class="card-header">
                    <i class="fas fa-building"></i>
                    <h2>Login as INCOIS Official</h2>
                </div>
                <div class="card-body">
                    <p>Internal platform for INCOIS staff to manage ocean hazard data and monitoring systems.</p>
                    <div class="btn-container">
                        <a href="#" class="btn" onclick="openLoginModal('official')"><span>Official Login</span> <i class="fas fa-arrow-right"></i></a>
                    </div>
                    <p>Use username:- official1 and password:- 123456</p>
                </div>
            </div>
            
            <div class="login-card verifier">
                <div class="card-header">
                    <i class="fas fa-check-circle"></i>
                    <h2>Login as Verifier</h2>
                </div>
                <div class="card-body">
                    <p>Verify and validate ocean hazard reports and monitoring data accuracy.</p>
                    <p>username:-verifier1 and password:- verifier123</p>
                    <div class="btn-container">
                        <a href="#" class="btn" onclick="openLoginModal('verifier')"><span>Verifier Login</span> <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Indian National Centre for Ocean Information Services (INCOIS) &copy; 2023</p>
            <p>Ocean Hazards Monitoring and Alert System</p>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('signupModal')">&times;</span>
            <div class="modal-header">
                <h2>Create User Account</h2>
                <p>Sign up to report coastal hazards and access ocean safety information</p>
            </div>
            <form id="signupForm" action="{{ url_for('signup') }}" method="POST">
                <div class="form-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" name="username" class="form-control" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" name="email" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" name="password" class="form-control" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirm_password" class="form-control" placeholder="Confirm your password" required>
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="full_name" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="form-control" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" class="form-control" placeholder="Enter your city/region">
                </div>
                <div class="form-options">
                    <div class="remember-me">
                        <input type="checkbox" id="terms" required>
                        <label for="terms">I agree to the <a href="#" style="color: #3498db;">Terms of Service</a> and <a href="#" style="color: #3498db;">Privacy Policy</a></label>
                    </div>
                </div>
                <div class="btn-container">
                    <button type="submit" class="btn"><span>Create Account</span> <i class="fas fa-user-plus"></i></button>
                </div>
            </form>
            <div class="modal-footer">
                <p>Already have an account? <a href="#" style="color: #3498db;" onclick="openLoginModal('user')">Login here</a></p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle">Login to Portal</h2>
                <p>Enter your credentials to access the system</p>
            </div>
            <form id="loginForm" action="{{ url_for('login') }}" method="POST">
                <input type="hidden" id="user_type" name="user_type" value="">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" class="form-control" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required>
                </div>
                <div class="form-options">
                    <div class="remember-me">
                        <input type="checkbox" id="remember">
                        <label for="remember">Remember me</label>
                    </div>
                    <a href="#" class="forgot-password" onclick="openForgotPasswordModal()">Forgot Password?</a>
                </div>
                <div class="btn-container">
                    <button type="submit" class="btn"><span>Login</span> <i class="fas fa-arrow-right"></i></button>
                </div>
            </form>
            <div class="modal-footer">
                <p>Don't have an account? <a href="#" style="color: #3498db;" onclick="openSignupModal()">Sign up here</a></p>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('forgotPasswordModal')">&times;</span>
            <div class="modal-header">
                <h2>Reset Your Password</h2>
                <p>Enter your email to receive a verification code</p>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email address" required>
                </div>
                <button type="button" class="modal-btn" onclick="sendVerificationCode()">Send Verification Code</button>
            </form>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal" id="otpModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('otpModal')">&times;</span>
            <div class="modal-header">
                <h2>Verify Your Identity</h2>
                <p>Enter the 6-digit code sent to your email</p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 1)">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 2)">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 3)">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 4)">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 5)">
                <input type="text" class="otp-input" maxlength="1" onkeyup="moveToNext(this, 6)">
            </div>
            <p style="text-align: center; margin-bottom: 20px;">
                Didn't receive the code? <a href="#" class="resend-otp" onclick="resendOTP()">Resend</a>
            </p>
            <button type="button" class="modal-btn" onclick="verifyOTP()">Verify & Reset Password</button>
        </div>
    </div>

    <!-- New Password Modal -->
    <div class="modal" id="newPasswordModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('newPasswordModal')">&times;</span>
            <div class="modal-header">
                <h2>Create New Password</h2>
                <p>Your new password must be different from previous used passwords</p>
            </div>
            <form id="newPasswordForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                </div>
                <button type="button" class="modal-btn" onclick="updatePassword()">Update Password</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUserType = '';
        let userEmail = '';

        // Open signup modal
        function openSignupModal() {
            document.getElementById('signupModal').style.display = 'flex';
        }

        // Open login modal for specific user type
        function openLoginModal(userType) {
            currentUserType = userType;
            const modalTitle = document.getElementById('modalTitle');
            document.getElementById('user_type').value = userType;
            
            if (userType === 'user') {
                modalTitle.textContent = 'Login as User';
            } else if (userType === 'official') {
                modalTitle.textContent = 'Login as INCOIS Official';
            } else if (userType === 'verifier') {
                modalTitle.textContent = 'Login as Verifier';
            }
            
            document.getElementById('loginModal').style.display = 'flex';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Open forgot password modal
        function openForgotPasswordModal() {
            closeModal('loginModal');
            document.getElementById('forgotPasswordModal').style.display = 'flex';
        }

        // Password confirmation validation
        document.getElementById('signupForm')?.addEventListener('submit', function(e) {
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match. Please try again.');
                return false;
            }
        });

        // Send verification code
        function sendVerificationCode() {
            userEmail = document.getElementById('email').value;
            
            if (!userEmail) {
                alert('Please enter your email address');
                return;
            }
            
            fetch('/api/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Verification code sent to ${userEmail}. Your OTP: ${data.otp}`);
                    closeModal('forgotPasswordModal');
                    document.getElementById('otpModal').style.display = 'flex';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Move to next OTP input field
        function moveToNext(current, next) {
            if (current.value.length === 1) {
                if (next <= 6) {
                    document.querySelectorAll('.otp-input')[next].focus();
                }
            }
        }

        // Resend OTP
        function resendOTP() {
            fetch('/api/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`New verification code sent to ${userEmail}. Your OTP: ${data.otp}`);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Verify OTP
        function verifyOTP() {
            let enteredOTP = '';
            const otpInputs = document.querySelectorAll('.otp-input');
            
            otpInputs.forEach(input => {
                enteredOTP += input.value;
            });
            
            fetch('/api/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: userEmail, otp: enteredOTP })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('otpModal');
                    document.getElementById('newPasswordModal').style.display = 'flex';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Update password
        function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Please enter and confirm your new password');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                return;
            }
            
            fetch('/api/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: userEmail, new_password: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password updated successfully! You can now login with your new password.');
                    closeModal('newPasswordModal');
                    
                    // Clear the OTP inputs
                    const otpInputs = document.querySelectorAll('.otp-input');
                    otpInputs.forEach(input => {
                        input.value = '';
                    });
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>